<script>
'use strict';

window.DATA_SCHEMA_VERSION = '1';
window.migrateOverlay = function(overlay) {
    if (overlay) {
        var i = 0;
        while (overlay.version !== window.DATA_SCHEMA_VERSION) {
            window.overlayVersion[i].migrate(overlay);
        }
    }
};

window.migrateUnit = function(unit) {
    if (unit && unit.overlays && unit.version !== window.DATA_SCHEMA_VERSION) {
        unit.overlays.forEach(window.migrateOverlay);
    }
    unit.version = window.DATA_SCHEMA_VERSION;
};

window.overlayVersion = [{
    version: '1',
    migrate: (function() {
        var overlay = {};

        function migrateMathCombination(combination) {
            var result = {};
            var expr = combination.value;

            if (!combination.value) {
                return;
            }

            if (typeof combination.value !== 'string') {
                expr = combination.value.expr;
                result.units = combination.value.units.split(' ');
            }

            if (overlay.type === 'custom-quiz') {
                // remove the <& and & and >
                var str = expr.substr(2, expr.length - 3);
                var variables = str.substr(0, str.indexOf('&'));
                expr = str.substr(str.indexOf('&') + 1).trim();
                if (overlay.items.length > 1) {
                    result.inputExp = variables.trim();
                }
            }

            // select the correct function
            var fun = expr.substr(0, expr.indexOf(' '));
            if (fun === '#approx') {
                var split = expr.split('#epsilon');
                result.error = split[1].trim();
                expr = split[0];
            }
            result.fun = fun;
            result.exp = expr.replace(fun, '').trim();

            combination.value = result;
            console.log('Combination Version updated:', combination.value);
        }

        return function(o) {
            overlay = o;
            if (overlay.type === 'custom-quiz' || overlay.type === 'math-quiz') {
                overlay.combinations.forEach(migrateMathCombination);
            }
            overlay.version = '1';
        };
    })()
}];
</script>
