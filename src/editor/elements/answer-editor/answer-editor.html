<!-- TODO: style this pretty -->
<!-- TODO: limit feedback chars and show hint to create an annotation if feedback to large-->
<dom-module id="answer-editor">
    <style>
    :host {
        display: block;
        @apply(--paper-font-body2);
    }
    
    #content {
        padding: 8px 16px;
        @apply(--layout-vertical);
        @apply(--layout-scroll);
        height: calc(100% - 120px);
    }
    </style>
    <template>
        <right-bar-header>Define Answer</right-bar-header>
        <div id="content">
            <span hidden$="{{!_hasValue(combination.value)}}">
                <label for="value">Answer:</label>
                <content></content>
            </span>
            <span hidden$="{{_hasValue(combination.value)}}">
                (default)
            </span>
            <div>Grade:</div>
            <paper-radio-group id="correct" selected="{{grade}}">
                <paper-radio-button name="0">Correct</paper-radio-button>
                <paper-radio-button name="1">Neutral</paper-radio-button>
                <paper-radio-button name="2">Incorrect</paper-radio-button>
            </paper-radio-group>
            <label for="feedback">Feedback:</label>
            <paper-input id="feedback" value="{{combination.feedback}}" placeholder="Feedback for this answer."></paper-input>
            <br/>
            <label for="action">Action:</label>
            <paper-dropdown-menu>
                <paper-menu class="dropdown-content" selected="{{action}}" id="action">
                    <paper-item>Play video</paper-item>
                    <paper-item>Seek to</paper-item>
                    <paper-item>Show overlay</paper-item>
                    <paper-item>Do nothing</paper-item>
                </paper-menu>
            </paper-dropdown-menu>
            <div id="timestampContainer">
                <label for="timestamp">Timestamp:</label>
                <paper-input id="timestamp" value="{{timestamp}}"></paper-input>
            </div>
            <div id="overlayContainer">
                <label for="overlay">Overlay ID:</label>
                <paper-input id="overlay" value="{{overlay}}"></paper-input>
            </div>
            <br/>
            <paper-button raised on-click="_save">Save</paper-button>
        </div>
    </template>
</dom-module>
<script>
'use strict';
(function() {
    Polymer({
        is: 'answer-editor',
        behaviors: [Capira.RightBar],
        properties: {
            combination: {
                type: Object,
                observer: '_loadCombination',
                notify: true
            },
            action: {
                type: String,
                value: '0',
                notify: true,
                observer: '_updateAction'
            },
            timestamp: {
                type: Number
            },
            grade: {
                observer: '_gradeChanged'
            }
        },

        // set the reaction and correct fields manually
        // since the polymer elements require integer indices
        _loadCombination: function(c) {
            if (c) {
                // switch (c.grade) {
                //     case true:
                //         this.correct = '0';
                //         break;
                //     default:
                //         this.correct = '2';
                // }
                this.updateGrade = false;
                this.grade = c.grade + '';
                this.updateGrade = true;
                switch (c.reaction) {
                    case 'showOverlay':
                        this.action = 2;
                        break;
                    case 'seekTo':
                        this.action = 1;
                        break;
                    case 'play':
                        this.action = 0;
                        break;
                    default:
                        if (c.correct) {
                            this.action = 0;
                        } else {
                            this.action = 3;
                        }
                }
            }
        },

        _gradeChanged: function() {
            if (this.updateGrade) {
                this.set('combination.grade', parseInt(this.grade));
            }
        },

        _updateAction: function(action) {
            this.$.timestampContainer.hidden = !(action === 1 || action === '1');
            this.$.overlayContainer.hidden = !(action === 2 || action === '2');
        },

        _hasValue: function(value) {
            return (typeof value !== 'undefined');
        },

        _save: function() {
            var reaction = {};
            switch (this.action) {
                case 0:
                    reaction.type = 'play';
                    break;
                case 1:
                    reaction.type = 'seekTo';
                    reaction.target = this.timestamp;
                    break;
                case 2:
                    reaction.type = 'showOverlay';
                    reaction.target = this.overlay;
                    break;
            }

            if (reaction.type) {
                this.set('combination.reaction', reaction);
            }

            this.fire('edit-state', 'default');
        }

    });
})();
</script>
