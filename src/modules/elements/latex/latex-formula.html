<link rel="import" href="latex-styles.html">
<dom-module id="latex-formula">
    <style include="latex-styles"></style>
    <template>
        <span id="tex"></span>
    </template>
</dom-module>
<script>
'use strict';
(function() {
    var _callbacks = [];

    function _loadKatex() {
        var script = document.createElement('script');
        script.setAttribute('src', '/bower_components/katex/dist/katex.min.js');
        script.setAttribute('type', 'text/javascript');
        script.onload = function() {
            _callbacks.forEach(function(cb) {
                cb();
            });
            _callbacks = null;
        };
        document.body.appendChild(script);
    }

    Polymer({
        is: 'latex-formula',
        behaviors: Capira.selectBehaviors([], [], Capira.EditableLatex),
        attached: function() {
            this.contentEditable = false;
            var latexExp = Polymer.dom(this).innerHTML;
            this.render(latexExp);
        },
        render: function(latexExp) {
            Polymer.dom(this).innerHTML = latexExp;
            //replace html entities
            latexExp = latexExp.replace('&lt;', '<').replace('&gt;', '>');
            this.latexExp = latexExp;
            this._execOnReady(function() {
                this.$.tex.innerHTML = '';
                window.katex.render(latexExp, this.$.tex);
            }.bind(this));
        },
        _execOnReady: function(callback) {
            if (!window.katex) {
                window.katex = 'pending';
                _callbacks.push(callback);
                _loadKatex();
            } else if (window.katex === 'pending') {
                _callbacks.push(callback);
            } else {
                callback();
            }
        }
    });
})();
</script>
