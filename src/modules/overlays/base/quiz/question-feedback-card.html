<link rel="import" href="wrong-answer-animation.html">
<link rel="import" href="../overlay/animatable-fab.html">
<dom-module id="question-feedback-card">
    <style>
    :host {
        display: block;
    }
    
    #container {
        position: relative;
        box-sizing: border-box;
        color: white;
        background-color: var(--quiz-primary-color);
        overflow: visible;
        @apply(--paper-font-headline);
        width: 100%;
        height: 100%;
    }
    
    #container > div {
        width: 100%;
        height: 100%;
        @apply(--layout-horizontal);
        overflow: hidden;
    }
    
    #text-container {
        padding: 0px 24px 0px 24px;
        @apply(--layout-vertical);
        @apply(--layout-self-center);
    }
    
    #container.wrong {
        background-color: var(--quiz-wrong-primary-color);
    }
    
    #container.correct {
        background-color: var(--quiz-correct-primary-color);
    }
    
    #fab {
        position: absolute;
        right: 24px;
        bottom: -34px;
        display: none;
        z-index: 2;
    }
    
    #fab.is-top {
        bottom: inherit;
        top: -29px;
    }
    
    #fab.fab-wrong {
        --paper-fab-background: var(--default-primary-color);
    }
    
    .correct #question-container,
    .wrong #question-container,
    .neutral #question-container {
        display: none;
    }
    
    #feedback-container {
        opacity: 0;
        height: 0;
    }
    
    .correct #feedback-container,
    .wrong #feedback-container,
    .neutral #feedback-container {
        opacity: 1;
        height: auto;
    }
    
    #icon-container {
        @apply(--layout);
        @apply(--layout-center-center);
        background-color: rgba(0, 0, 0, 0.2);
        height: 100%;
        width: 64px;
    }
    
    #icon-container iron-icon {
        width: 40px;
        height: 40px;
    }
    
    #feedback > a {
        color: white !important;
    }
    </style>
    <template>
        <div id="container">
            <div>
                <div id="icon-container" hidden$="{{!icon}}">
                    <iron-icon icon="{{icon}}"></iron-icon>
                </div>
                <div id="text-container">
                    <div id="question-container" hidden$="{{!question}}">
                        <div id="question">
                            <mark-up content="{{question}}"></mark-up>
                        </div>
                    </div>
                    <div id="feedback-container">
                        <mark-up id="feedback" uneditable="1"></mark-up>
                    </div>
                </div>
            </div>
            <animatable-fab icon="{{_fabIcon}}" on-tap="_nextAction" id="fab"></animatable-fab>
        </div>
    </template>
</dom-module>
<script>
'use strict';
(function() {
    Polymer({
        is: 'question-feedback-card',
        behaviors: [Polymer.NeonAnimationRunnerBehavior],
        properties: {
            question: {
                type: String,
                value: null,
                notify: true
            },
            _feedback: String,
            _state: {
                type: String,
                value: null, // possible states: question, wrong, correct
                observer: '_onStateChange'
            },
            _fabIcon: {
                type: String,
                computed: '_computeFabIcon(_state)'
            },
            _fabClass: {
                type: String,
                computed: '_computeFabClass(_state)'
            },
            isTop: {
                type: Boolean,
                value: false
            },
            animateWrong: {
                type: Boolean,
                value: false
            },
            icon: {
                type: String,
                value: null
            },
            animationConfig: {
                type: Object,
                value: function() {
                    return {
                        'wrong-answer': {
                            name: 'wrong-answer-animation',
                            node: this,
                            duration: 900

                        }
                    };
                }
            },
            _opened: {
                value: true
            }
        },
  

        attached: function() {
            if (this.isTop) {
                this.$.fab.classList.add('is-top');
            }
        },

        _onStateChange: function(newState) {
            if (this._opened) {
                this._computeFabClass();
                this.$.container.classList.remove('neutral');
                this.$.container.classList.remove('correct');
                this.$.container.classList.remove('wrong');
                switch (newState) {
                    case 'correct':
                        this.$.container.classList.add('correct');
                        //document.body.style.backgroundColor = '#b9f6ca';
                        return;
                    case 'wrong':
                        this.$.container.classList.add('wrong');
                        //document.body.style.backgroundColor = '#ff9e80';

                        if (this.animateWrong) {
                            this.cancelAnimation();
                            this.playAnimation('wrong-answer');
                        }
                        return;
                    case 'neutral':
                        this.$.container.classList.add('neutral');
                        return;
                    default:
                        //document.body.style.backgroundColor = '#8c9eff';
                        return;
                }
            }
        },
        wasAnswered: function() {
            this._state = 'question';
            this.$.fab.show();
        },
        show: function() {
            this._opened = true;
            this._state = 'question';
            this.$.fab.hide();
            //document.body.style.backgroundColor = '#8c9eff';
        },
        showFeedback: function(combination) {
            this.combination = combination;
            this.$.feedback.content = combination.feedback;
            switch (combination.grade) {
                case Capira.Grade.CORRECT:
                    this.set('_state', 'correct');
                    break;
                case Capira.Grade.INCORRECT:
                    this.set('_state', 'wrong');
                    break;
                case Capira.Grade.NEUTRAL:
                    this.set('_state', 'neutral');
                    break;
                default:
                    this.set('_state', 'question');
                    break;
            }
        },
        _nextAction: function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (this._state === 'question') {
                this.fire('quiz-answered');
                return;
            } else if (!this.combination.reaction) {
                // repeat question
                this._state = 'question';
            } else {
                this._done();
            }
        },
        _computeFabIcon: function(state) {
            if (state === 'question') {
                return 'player-icons:check';
            } else if (this.combination && !this.combination.reaction) {
                // repeat question
                return 'player-icons:replay';
            } else {
                return 'player-icons:play-arrow';
            }
        },
        _computeFabClass: function() {
            if (this._state === 'wrong') {
                this.$.fab.classList.add('fab-wrong');
            } else {
                this.$.fab.classList.remove('fab-wrong');
            }
        },
        _done: function() {
            this.fire('quiz-done', this.combination.reaction);
        }

    });
})();
</script>
