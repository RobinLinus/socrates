<link rel="import" href="latex-styles.html">
<dom-module id="latex-formula">
    <style include="latex-styles"></style>
    <template>
        <span id="formula"></span>
    </template>
</dom-module>
<script>
(function() {
    'use strict';
    var __katexCallbacks = [];

    function __loadKatex() {
        function performCallbacks() {
            __katexCallbacks.forEach(function(callback) {
                callback();
            });
            __katexCallbacks = null; // free up the memory
        }

        // load katex
        var script = document.createElement('script');
        script.setAttribute('type', 'text/javascript');
        script.setAttribute('src', '/bower_components/katex/dist/katex.min.js');
        script.onload = function() {
            performCallbacks();
        };
        document.body.appendChild(script);
    }

    Polymer({
        is: 'latex-formula',
        attached: function() {
            this._execOnReady(function() {
                var formulaEl = this.$.formula;
                var texString = Polymer.dom(this).innerHTML;
                //clean string from 
                texString = texString.replace('&lt;', '<').replace('&gt;', '>');
                window.katex.render(texString, formulaEl);
            }.bind(this));
        },
        _execOnReady: function(callback) {
            if (!window.katex) {
                window.katex = 'loading';
                __katexCallbacks.push(callback);
                __loadKatex();
            } else if (window.katex === 'loading') {
                __katexCallbacks.push(callback);
            } else {
                callback();
            }
        }
    });
})();
</script>
