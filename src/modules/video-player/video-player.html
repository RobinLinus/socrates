<script src="event-timer.js"></script>
<link rel="import" href="../../../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="overlays-timeline.html">
<link rel="import" href="fullscreen-button.html">
<dom-module id="video-player">
    <style>
    :host {
        display: block;
        height: 100%;
    }
    
    google-youtube {
        height: 100%;
    }
    </style>
    <template>
        <google-youtube main video-id="[[unit.video.source]]" height="100%" width="100%" rel="0" autoplay="[[autoplay]]" controls="1" showinfo="0" fs="0" id="player" duration="{{duration}}" playbackstarted="{{playbackstarted}}" state="{{state}}">
        </google-youtube>
        <overlays-timeline duration="{{duration}}" overlays="{{unit.overlays}}" id="timeline"></overlays-timeline>
        <fullscreen-button id="full"></fullscreen-button>
    </template>
</dom-module>
<script>
'use strict';
(function() {
    Polymer({
        is: 'video-player',
        properties: {
            unit: {
                type: Object,
                notify: true
            },
            autoplay: {
                value: 0
            },
            playbackstarted: {
                type: Boolean,
                observer: '_playerReady'
            },
            state: {
                type: Number,
                notify: true
            }
        },
        attached: function() {
            this.addEventListener('mouseenter', this._showTimeline.bind(this), false);
            this.addEventListener('mousemove', this._showTimeline.bind(this), false);
            //this.$.player.addEventListener('mousemove', this._showTimeline.bind(this), false);
            this.addEventListener('mouseleave', this._hideTimeline.bind(this), false);
        },

        _playerReady: function() {
            if (this.playbackstarted) {
                window.app.player = this.$.player;
                app.player.getCurrentTime = function() {
                    return app.player._player.getCurrentTime();
                };
                app.player.play = function() {
                    app.player._player.playVideo();
                    this.$.timeline.hide();
                }.bind(this);

                app.eventTimer = window.EventTimer(app.player, function(type, overlay) {
                    switch (type) {
                        case 'show':
                            app.overlays.show(overlay.id);
                            break;
                        case 'hide':
                            app.overlays.hide(overlay.id);
                            break;
                    }
                });

                this.addEventListener('overlay-selected', function(e) {
                    app.eventTimer.seekTo(e.detail);
                });

                window.dispatchEvent(new Event('resize'));
                app.eventTimer.start();
                this._iframeMouseEventsHack();
                this.fire('video-ready');
            }
        },

        _showTimeline: function() {
            this.$.timeline.show();
            this.$.full.show();
            clearTimeout(this.hideTimer);
            this.hideTimer = setTimeout(function() {
                this._hideTimeline();
            }.bind(this), 3000);
        },
        _hideTimeline: function() {
            if (this.state !== 2) { //always show during pause
                this.$.timeline.hide();
                this.$.full.hide();
            }
        },


        _iframeMouseEventsHack: function() {
            /*  
                This evil hack detects mousemove-events inside the yt-iframe.
                The idea is to disable the pointer events on the iframe, capture one mouse-move event from the surrounding container, activate the mouse-events again and repeat that every 3s.
             */
            var iframe = app.player._player.getIframe();
            iframe.title = null;
            var container = this.$.player;
            iframe.style.pointerEvents = 'none';
            container.addEventListener('mousemove', function(e) {
                iframe.style.pointerEvents = 'all';
                setTimeout(function() {
                    iframe.style.pointerEvents = 'none';
                }, 3000);
            });
        }

    });
})();
</script>
