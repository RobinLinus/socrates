<link rel="import" href="../editor/right-bar/right-bar.html">
<link rel="import" href="../editor/right-bar/right-bar-header/right-bar-header.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../mark-up/mark-up.html">
<dom-module id="multi-answer-value-right-bar">
    <template>
        <style>
        :host {
            display: block;
            @apply(--paper-font-body1);
        }
        
        #content {
            box-sizing: border-box;
            padding: 16px;
        }
        
        paper-checkbox {
            display: block;
            padding: 8px;
        }
        
        paper-button {
            margin-top: 16px;
            float: right;
        }
        </style>
        <right-bar-header>Select Options</right-bar-header>
        <div id="content">
            <template is="dom-repeat" items="{{overlay.options}}" id="list">
                <paper-checkbox checked$="[[_computeChecked(index)]]" on-iron-change="toggleSelection" on-change="_computeValue">
                    <mark-up content="[[item]]"></mark-up>
                </paper-checkbox>
            </template>
            <paper-button raised on-tap="_done">Save</paper-button>
        </div>
        <array-selector multi items="{{overlay.options}}" selected="{{selected}}" id="selector" selectedProperty="checked" toogle></array-selector>
    </template>
    <script>
    'use strict';
    Polymer({
        is: 'multi-answer-value-right-bar',
        behaviors: [Capira.RightBar],
        properties: {
            overlay: Object,
            combination: {
                type: Object,
                notify: true,
                observer: '_combinationChanged'
            }
        },
        _done: function() {
            this.fire('edit-state', 'combination');
        },
        _combinationChanged: function() {
            if (this.overlay) {
                this.overlay.options.forEach(function(option) {
                    this.$.selector.deselect(option);
                }.bind(this));
                this.$.list.render();
            }
        },
        _computeChecked: function(optionIndex) {
            return this.combination.value.indexOf(optionIndex) > 0;
        },
        toggleSelection: function(e) {
            if (e && e.target && this.combination && this.overlay && this.overlay.options) {
                var selector = this.$.selector;
                var item = this.$.list.itemForElement(e.target);

                if (e.target.checked) {
                    selector.select(item);
                } else {
                    selector.deselect(item);
                }
            }
        },
        _computeValue: function() {
            var value = [];
            this.$.selector.selected.forEach(function(option) {
                value.push(this.overlay.options.indexOf(option));
            }.bind(this));
            this.combination.value = value;
        }
    });
    </script>
</dom-module>
