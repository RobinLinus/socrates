<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../capira-icons/icons.html">
<link rel="import" href="fullscreen-button.html">
<link rel="import" href="video-controls-animations.html">
<dom-module id="video-controls">
    <template>
        <style>
        :host {
            display: block;
            width: 100%;
            color: white;
            position: relative;
            display: none;
        }
        
        :host,
        #progress {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        #progress {
            background-color: transparent;
            padding-top: 3px;
            height: 5px;
            cursor: pointer;
            z-index: 4;
        }
        
        #progressed {
            background-color: var(--paper-green-500);
            height: 100%;
        }
        
        #controls {
            height: 36px;
            background-color: rgba(0, 0, 0, 0.3);
            @apply(--layout-horizontal);
            @apply(--layout-center);
        }
        
        #duration {
            @apply(--paper-font-body2);
            line-height: 21px;
            vertical-align: bottom;
        }
        
        #play,
        #pause {
            padding: 0 12px;
            cursor: pointer;
        }
        
        #right {
            position: absolute;
            right: 8px;
            top: 6px;
        }
        
        [hidden] {
            display: none !important;
        }
        </style>
        <div id="progress">
            <div id="progressed" style$="{{cProgressStyle}}"></div>
            <div id="loaded"></div>
        </div>
        <div id="controls">
            <div id="left">
                <iron-icon icon="player-icons:play-arrow" hidden$="{{isPlaying}}" id="play" on-tap="_play"></iron-icon>
                <iron-icon icon="player-icons:pause" hidden$="{{!isPlaying}}" id="pause" on-tap="_pause"></iron-icon>
                <span id="duration">{{cProgress}}</span>
            </div>
            <div id="right">
                <fullscreen-button></fullscreen-button>
                <span id="yt-logo"></span>
            </div>
            <content></content>
        </div>
    </template>
    <script>
    'use strict';
    Polymer({
        is: 'video-controls',
        behaviors: [Capira.VideoControlsAnimations],
        properties: {
            currentTime: {
                type: Number,
                value: 0
            },
            duration: {
                type: Number,
                value: 0
            },
            cProgress: {
                computed: '_computeProgress(currentTime,duration)'
            },
            cProgressStyle: {
                computed: '_computeProgressStyle(currentTime,duration)'
            },
            isPlaying: {
                type: Boolean,
                value: false
            }
        },
        _computeTime: function(time) {
            var hrs = parseInt(time / 3600);
            hrs = hrs > 0 ? hrs + ':' : '';

            var mins = parseInt((time % 3600) / 60);
            mins = mins > 9 ? mins : '0' + mins;
            mins = mins ? mins : '00';

            var secs = parseInt(time % 60);
            secs = secs > 9 ? secs : '0' + secs;
            secs = secs ? secs : '00';

            return hrs + mins + ':' + secs;
        },
        _computeProgress: function(currentTime, duration) {
            return this._computeTime(currentTime) + ' / ' + this._computeTime(duration);
        },
        _computeProgressStyle: function(currentTime, duration) {
            return 'width:' + (currentTime / duration) * 100 + '%';
        },
        _play: function() {
            this.player.play();
        },
        _pause: function() {
            this.player.pause();
        },
        attached: function() {
            var progress = this.$.progress;
            var background = document.body;

            var seekStart = function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.mousedown = true;
            }.bind(this);

            var seekPerformed = function(e) {
                if (this.mousedown) {
                    e.preventDefault();
                    e.stopPropagation();
                    var x = e.pageX - progress.getBoundingClientRect().left;
                    var seekToTime = x / progress.clientWidth * this.duration;
                    //this.currentTime = seekToTime;
                    this.player.seekTo(seekToTime);
                }
            }.bind(this);

            var seekEnd = function(e) {
                seekPerformed(e);
                this.mousedown = false;
            }.bind(this);

            //mouse events
            progress.addEventListener('mousedown', seekStart, false);
            background.addEventListener('mousemove', seekPerformed, false);
            background.addEventListener('mouseup', seekEnd, false);
            background.addEventListener('mouseleave', seekEnd, false);

            //touch events 
            progress.addEventListener('touchstart', seekStart, false);
            background.addEventListener('touchmove', seekPerformed, false);
            background.addEventListener('touchend', seekEnd, false);
            background.addEventListener('touchcancel', seekEnd, false);

        },
        setPlayer: function(player) {
            this.player = player;
            setInterval(function() {
                this.currentTime = this.player.getCurrentTime();
            }.bind(this), 100);
        }
    });
    </script>
</dom-module>
