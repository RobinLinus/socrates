<script src="event-timer.js"></script>
<link rel="import" href="../../bower_components/google-youtube/google-youtube.html">
<link rel="import" href="video-player-html5/video-player-html5.html">
<link rel="import" href="video-player-youtube/video-player-youtube.html">
<link rel="import" href="video-controls/video-controls.html">
<link rel="import" href="overlays-timeline/overlays-timeline.html">
<dom-module id="video-player">
    <template>
        <style>
        :host {
            width: 45%;
            background: rgba(0, 0, 0, 0.7);
            position: relative;
            display: inline-block;
            margin: 1%;
            vertical-align: top;
            box-shadow: 0 0 4px rgba(0, 0, 0, .3);
        }
        
        :host:before {
            padding-top: 56.25%;
            content: '';
            display: block;
        }
        
        .players {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
        }
        
        video-controls {
            position: absolute;
            bottom: 0;
        }
        </style>
        <div class="players" main>
            <template is="dom-if" if="[[isYoutube]]">
                <video-player-youtube id="youtube" src="[[unit.video.src]]" current-time="{{currentTime}}" duration="{{duration}}" is-playing="{{isPlaying}}"></video-player-youtube>
            </template>
            <template is="dom-if" if="[[isHTML5]]">
                <video-player-html5 id="html5" src="[[unit.video.src]]" current-time="{{currentTime}}" duration="{{duration}}" is-playing="{{isPlaying}}"></video-player-html5>
            </template>
            <video-controls current-time="{{currentTime}}" duration="{{duration}}" is-playing="{{isPlaying}}" id="controls"></video-controls>
            <overlays-timeline duration="{{duration}}" overlays="{{unit.overlays}}" id="timeline"></overlays-timeline>
        </div>
    </template>
</dom-module>
<script>
'use strict';
(function() {
    Polymer({
        is: 'video-player',
        behaviors: Capira.selectBehaviors({
            editor: Capira.CenterStage
        }),
        properties: {
            unit: {
                type: Object,
                notify: true
            },
            autoplay: {
                value: 0
            },
            isYoutube: {
                computed: '_computeIsYoutube(unit)'
            },
            isHTML5: {
                computed: '_computeIsHTML5(unit)'
            },
            isPlaying: {
                observer: '_stateChanged'
            }
        },
        _computeIsYoutube: function(unit) {
            return unit.video.type === 'yt';
        },

        _computeIsHTML5: function(unit) {
            return unit.video.type === 'html5';
        },

        listeners: {
            'play-clicked': 'play',
            'pause-clicked': 'pause',
            'seek-to': 'seekTo',
            'player-ready': '_playerReady',
        },

        get player() {
            if (this.isYoutube) {
                return this.$$('#youtube');
            }
            if (this.isHTML5) {
                return this.$$('#html5');
            }
        },

        play: function() {
            this.player.play();
        },
        pause: function() {
            this.player.pause();
        },
        seekTo: function(e) {
            var time = e.detail;
            this.player.seekTo(time);
        },

        _playerReady: function() {
            window.app = window.app || {};
            window.app.player = this.player;
            app.eventTimer = window.EventTimer(app.player, function(type, overlay) {
                switch (type) {
                    case 'show':
                        app.overlays.show(overlay.id);
                        break;
                    case 'hide':
                        app.overlays.hide(overlay.id);
                        break;
                }
            });

            this.addEventListener('overlay-selected', function(e) {
                app.eventTimer.seekTo(e.detail);
            }, false);

            this.addEventListener('mousemove', function(e) {
                this._showControls();
            }.bind(this), false);

            app.eventTimer.start();
            this.fire('video-ready');
        },

        _showControls: function() {
            this.$.timeline.show();
            this.$.controls.show();
            clearTimeout(this.hideTimer);
            this.hideTimer = setTimeout(function() {
                this._hideControls();
            }.bind(this), 3000);
        },
        _hideControls: function() {
            if (this.isPlaying) { //don't hide during pause
                this.$.timeline.hide();
                this.$.controls.hide();
            }
        },

        _stateChanged: function(isPlaying) {
            if (isPlaying) {
                this._showControls();
            }
        }
    });
})();
</script>
